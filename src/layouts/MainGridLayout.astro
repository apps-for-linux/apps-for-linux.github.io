---
import BackToTop from "@components/control/BackToTop.astro";
import Footer from "@components/Footer.astro";
import Navbar from "@components/Navbar.astro";
import SideBar from "@components/widget/SideBar.astro";
import type { MarkdownHeading } from "astro";
import { Icon } from "astro-icon/components";
import IconifyLoader from "../components/misc/IconifyLoader.astro";
import { postConfig, sidebarLayoutConfig, siteConfig } from "../config";
import { widgetManager } from "../utils/widget-manager";
import Layout from "./Layout.astro";

import "../styles/maingrid.css";

const { title, description, lang, postSlug, headings = [] } = Astro.props;

/**
 * SideBar
 */

// Check if the sidebar is enabled and dynamically adjust the grid layout.
// 判断左右侧边栏是否有启用组件
const hasLeftSidebar = widgetManager.hasEnabledSidebarOnSide("left");
const hasRightSidebar = widgetManager.hasEnabledSidebarOnSide("right");
// 响应式配置：不同设备上的侧边栏显示状态（只要任一侧存在组件且布局为 sidebar 即视为显示）
const mobileShowSidebar =
	(hasLeftSidebar || hasRightSidebar) &&
	widgetManager.shouldShowSidebar("mobile");
const tabletShowSidebar =
	(hasLeftSidebar || hasRightSidebar) &&
	widgetManager.shouldShowSidebar("tablet");
const desktopShowSidebar =
	(hasLeftSidebar || hasRightSidebar) &&
	widgetManager.shouldShowSidebar("desktop");

// 动态网格布局类名 - 根据左右侧边栏情况调整列宽
// 手机端：单列布局，主内容在上，侧栏在下
// 平板端：双列布局，左侧栏+右侧栏（上下堆叠）在左列，主内容在右列
// 桌面端：三列布局，左侧栏 | 主内容 | 右侧栏
const gridCols = `
    grid-cols-1
    ${
			tabletShowSidebar
				? hasLeftSidebar || hasRightSidebar
					? "md:grid-cols-[17.5rem_1fr]"
					: "md:grid-cols-1"
				: "md:grid-cols-1"
		}
    ${
			desktopShowSidebar
				? hasLeftSidebar && hasRightSidebar
					? "lg:grid-cols-[17.5rem_1fr_17.5rem]"
					: hasLeftSidebar
						? "lg:grid-cols-[17.5rem_1fr]"
						: hasRightSidebar
							? "lg:grid-cols-[1fr_17.5rem]"
							: "lg:grid-cols-1"
				: "lg:grid-cols-1"
		}
`
	.trim()
	.replace(/\s+/g, " ");

// 左侧侧边栏容器类名
// 手机端：显示在主内容下方
// 平板端：显示在左列第1行
// 桌面端：显示在第1列
const leftSidebarClass = `
    mb-0 col-span-1 onload-animation
    ${
			mobileShowSidebar && hasLeftSidebar
				? "block row-start-2 row-end-3"
				: "hidden"
		}
    ${
			tabletShowSidebar && hasLeftSidebar
				? "md:block md:row-start-1 md:row-end-2 md:max-w-[17.5rem] md:col-start-1 md:col-end-2"
				: "md:hidden"
		}
    ${
			desktopShowSidebar && hasLeftSidebar
				? "lg:block lg:row-start-1 lg:row-end-2 lg:max-w-[17.5rem] lg:col-start-1 lg:col-end-2"
				: "lg:hidden"
		}
`
	.trim()
	.replace(/\s+/g, " ");

// 右侧侧边栏容器类名
// 手机端：显示在左侧栏下方
// 平板端：显示在左列第2行（左侧栏下方）
// 桌面端：显示在第3列（右侧）
const rightSidebarClass = `
    mb-0 col-span-1 onload-animation
    ${
			mobileShowSidebar && hasRightSidebar
				? "block row-start-3 row-end-4"
				: "hidden"
		}
    ${
			tabletShowSidebar && hasRightSidebar
				? "md:block md:row-start-2 md:row-end-3 md:max-w-[17.5rem] md:col-start-1 md:col-end-2"
				: "md:hidden"
		}
    ${
			desktopShowSidebar && hasRightSidebar
				? hasLeftSidebar
					? "lg:block lg:row-start-1 lg:row-end-2 lg:max-w-[17.5rem] lg:col-start-3 lg:col-end-4"
					: "lg:block lg:row-start-1 lg:row-end-2 lg:max-w-[17.5rem] lg:col-start-2 lg:col-end-3"
				: "lg:hidden"
		}
`
	.trim()
	.replace(/\s+/g, " ");

// 主内容区域类名
// 手机端：主内容在第1行
// 平板端：主内容在右列，纵向跨越所有侧栏行
// 桌面端：主内容在第2列
const mainContentClass = `
    transition-swup-fade overflow-hidden w-full
    col-span-1 row-start-1 row-end-2
    ${
			tabletShowSidebar
				? hasLeftSidebar || hasRightSidebar
					? "md:col-start-2 md:col-end-3 md:row-start-1 md:row-end-3"
					: "md:col-span-1"
				: "md:col-span-1"
		}
    ${
			desktopShowSidebar
				? hasLeftSidebar && hasRightSidebar
					? "lg:col-start-2 lg:col-end-3 lg:row-start-1 lg:row-end-2"
					: hasLeftSidebar
						? "lg:col-start-2 lg:col-end-3"
						: hasRightSidebar
							? "lg:col-start-1 lg:col-end-2"
							: "lg:col-span-1"
				: "lg:col-span-1"
		}
`
	.trim()
	.replace(/\s+/g, " ");
---

<Layout
    title={title}
    description={description}
    lang={lang}
    postSlug={postSlug}
>

    <!-- 全局图标加载器 -->
    <IconifyLoader />

    <!-- Navbar -->
    <slot slot="head" name="head" />
    <div
        id="top-row"
        class="z-50 pointer-events-none relative transition-all duration-700 max-w-[var(--page-width)] px-0 md:px-4 mx-auto"
        class:list={[""]}
    >
        <div
            id="navbar-wrapper"
            class="pointer-events-auto sticky top-0 transition-all"
        >
            <Navbar />
        </div>
    </div>

    <!-- Main content -->
    <div
        class={`absolute w-full z-30 pointer-events-none "no-banner-layout"`}
    >
        <!-- The pointer-events-none here prevent blocking the click event of the TOC -->
        <div
            class="relative max-w-[var(--page-width)] mx-auto pointer-events-auto"
        >
            <div
                id="main-grid"
                class={`transition duration-700 w-full left-0 right-0 grid ${gridCols} grid-rows-[auto_1fr_auto] lg:grid-rows-[auto] mx-auto gap-4 px-0 md:px-4 ${!mobileShowSidebar ? "mobile-no-sidebar" : ""} ${(hasLeftSidebar || hasRightSidebar) ? "mobile-both-sidebar" : ""}`}
            >

                {
                    (mobileShowSidebar ||
                        tabletShowSidebar ||
                        desktopShowSidebar) &&
                        hasLeftSidebar && (
                            <SideBar
                                side="left"
                                class={`${leftSidebarClass} `}
                                headings={headings}
                            />
                        )
                }
                {
                    (mobileShowSidebar ||
                        tabletShowSidebar ||
                        desktopShowSidebar) &&
                        hasRightSidebar && (
                            <SideBar
                                side="right"
                                class={`rightSidebarClass`}
                                headings={headings}
                            />
                        )
                }

                <main
                    id="swup-container"
                    class={`${mainContentClass} transition-main`}
                >
                    <div
                        id="content-wrapper"
                        class="onload-animation transition-leaving"
                    >
                        <!-- the overflow-hidden here prevent long text break the layout-->
                        <!-- make id different from windows.swup global property -->
                        <slot />
                        <div
                            class="footer col-span-2 onload-animation hidden lg:block"
                        >
                            <Footer />
                        </div>
                    </div>
                </main>

                <div class="footer col-span-2 onload-animation block lg:hidden">
                    <Footer />
                </div>
            </div>

            <BackToTop />
        </div>
    </div>
</Layout>
