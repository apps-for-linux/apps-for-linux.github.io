---
// 只加载最常用的字体权重，减少加载时间
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/700.css";

import ConfigCarrier from "@components/ConfigCarrier.astro";
import { profileConfig, siteConfig } from "@/config";
import { BREAKPOINT_LG } from "@/constants/breakpoints";
import {
	DARK_MODE,
	LIGHT_MODE,
	PAGE_WIDTH,
	SYSTEM_MODE,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon, ParticleConfig } from "../types/config";
import { pathsEqual, url } from "../utils/url-utils";

import "katex/dist/katex.css";
import "../styles/navbar.css";

interface Props {
	title?: string;
	description?: string;
	lang?: string;
	postSlug?: string;
}

let { title, description, lang, postSlug } = Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = siteConfig.subtitle
		? `${siteConfig.title} - ${siteConfig.subtitle}`
		: siteConfig.title;
}

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] text-[14px] md:text-[16px]"
	  data-overlayscrollbars-initialize
>
	<head>
		<!-- 延迟加载优化 -->
		<script is:inline>
			// 使用 requestIdleCallback 延迟加载第三方脚本
			function loadAnalytics() {
				// Google Tag Manager
				(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KRX3XGVH');
				// Clarity
				(function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window, document, "clarity", "script", "tjr3vkhj8i");
			}
			// 在浏览器空闲时加载，或者在 3 秒后加载
			if ('requestIdleCallback' in window) {
				requestIdleCallback(loadAnalytics, { timeout: 3000 });
			} else {
				setTimeout(loadAnalytics, 3000);
			}
		</script>

		<title>{pageTitle}</title>

		<meta charset="UTF-8" />
		<meta name="description" content={description || pageTitle}>
		{siteConfig.keywords && siteConfig.keywords.length > 0 && (
			<meta name="keywords" content={siteConfig.keywords.join(', ')} />
		)}
		<meta name="author" content={profileConfig.name}>

		<meta property="og:site_name" content={siteConfig.title}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={description || pageTitle}>

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={description || pageTitle}>

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{BREAKPOINT_LG, LIGHT_MODE, DARK_MODE, SYSTEM_MODE, PAGE_WIDTH, configHue, defaultTheme: siteConfig.defaultTheme}}>
			// Load the theme from local storage
			const theme = localStorage.getItem('theme') || defaultTheme;
			// Apply the theme to the document
			let isDark = false;
			switch (theme) {
				case LIGHT_MODE:
					document.documentElement.classList.remove('dark');
					isDark = false;
					break
				case DARK_MODE:
					document.documentElement.classList.add('dark');
					isDark = true;
					break
				case SYSTEM_MODE:
					if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
						document.documentElement.classList.add('dark');
						isDark = true;
					} else {
						document.documentElement.classList.remove('dark');
						isDark = false;
					}
			}
		const expressiveTheme = isDark ? "github-dark" : "github-light";
		document.documentElement.setAttribute("data-theme", expressiveTheme);

		// Load the hue from local storage
			const hue = localStorage.getItem('hue') || configHue;
		// Apply the hue to the document
		document.documentElement.style.setProperty('--hue', hue);
		</script>
		<style define:vars={{
			configHue,
			'page-width': `${PAGE_WIDTH}rem`,
		}}>
		</style>  
		<!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->



		<slot name="head"></slot>

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>

</head>

	<body class=" min-h-screen " class:list={[{"lg:is-home": isHomePage, }]}
		  data-overlayscrollbars-initialize
	>

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>

		<!-- Translate.js integration - lazy loading -->
		{siteConfig.translate?.enable && (
			<script>
				// 懒加载translate.js，只有在需要时才加载
				window.loadTranslateScript = function() {
					// 如果已经加载或正在加载，直接返回
					if (window.translateScriptLoaded) {
						return Promise.resolve();
					}
					if (window.translate || document.getElementById('translate-script')) {
						window.translateScriptLoaded = true;
						return Promise.resolve();
					}

					return new Promise((resolve, reject) => {
						const script = document.createElement('script');
						script.src = '/translate.js';
						script.id = 'translate-script';
						script.async = true;
						script.onload = () => {
							if (typeof window.translate !== 'undefined') {
								window.translateScriptLoaded = true;
								resolve();
							} else {
								reject(new Error('translate.js loaded but window.translate not available'));
							}
						};
						script.onerror = reject;
						document.head.appendChild(script);
					});
				};
			</script>
		)}
	</body>
</html>

<script>
import { animationManager } from '../utils/animation-utils';
import 'overlayscrollbars/overlayscrollbars.css';
import {
	OverlayScrollbars,
	// ScrollbarsHidingPlugin,
	// SizeObserverPlugin,
	// ClickScrollPlugin
} from 'overlayscrollbars';
import {getHue, getStoredTheme, setHue, setTheme} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
import { BREAKPOINT_LG } from "@/constants/breakpoints";
import { siteConfig } from '../config';
import { widgetConfigs } from "../config";
import { initParticle } from "../utils/particle-manager";

/* Preload fonts */
// (async function() {
// 	try {
// 		await Promise.all([
// 			document.fonts.load("400 1em Roboto"),
// 			document.fonts.load("700 1em Roboto"),
// 		]);
// 		document.body.classList.remove("hidden");
// 	} catch (error) {
// 		console.log("Failed to load fonts:", error);
// 	}
// })();

/* TODO This is a temporary solution for style flicker issue when the transition is activated */
/* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
/* update: fixed in Astro 3.2.4 */
/*
function disableAnimation() {
	const css = document.createElement('style')
	css.appendChild(
		document.createTextNode(
			`*{
			  -webkit-transition:none!important;
			  -moz-transition:none!important;
			  -o-transition:none!important;
			  -ms-transition:none!important;
			  transition:none!important
			  }`
		)
	)
	document.head.appendChild(css)

	return () => {
		// Force restyle
		;(() => window.getComputedStyle(document.body))()

		// Wait for next tick before removing
		setTimeout(() => {
			document.head.removeChild(css)
		}, 1)
	}
}

function setClickOutsideToClose(panel: string, ignores: string[]) {
	document.addEventListener("click", event => {
		let panelDom = document.getElementById(panel);
		let tDom = event.target;
		if (!(tDom instanceof Node)) return;		// Ensure the event target is an HTML Node
		for (let ig of ignores) {
			let ie = document.getElementById(ig)
			if (ie == tDom || (ie?.contains(tDom))) {
				return;
			}
		}
		panelDom!.classList.add("float-panel-closed");
	});
}
setClickOutsideToClose("display-setting", ["display-setting", "display-settings-switch"])
setClickOutsideToClose("nav-menu-panel", ["nav-menu-panel", "nav-menu-switch"])
setClickOutsideToClose("search-panel", ["search-panel", "search-bar", "search-switch"])

function loadTheme() {
	const theme = getStoredTheme()
	setTheme(theme)
}

function loadHue() {
	setHue(getHue())
}

function initCustomScrollbar() {
	// 完全禁用OverlayScrollbars的body初始化，避免导致页面重新加载
	// 只处理katex元素的滚动条
	const katexElements = document.querySelectorAll('.katex-display:not([data-scrollbar-initialized])') as NodeListOf<HTMLElement>;
	katexElements.forEach(element => {
		if (!element.parentNode) return;

		const container = document.createElement('div');
		container.className = 'katex-display-container';
		element.parentNode.insertBefore(container, element);
		container.appendChild(element);

		// 使用简单的CSS滚动条而不是OverlayScrollbars
		container.style.cssText = `
			overflow-x: auto;
			scrollbar-width: thin;
			scrollbar-color: rgba(0,0,0,0.3) transparent;
		`;

		// 为webkit浏览器添加自定义滚动条样式
		const style = document.createElement('style');
		style.textContent = `
			.katex-display-container::-webkit-scrollbar {
				height: 6px;
			}
			.katex-display-container::-webkit-scrollbar-track {
				background: transparent;
			}
			.katex-display-container::-webkit-scrollbar-thumb {
				background: rgba(0,0,0,0.3);
				border-radius: 3px;
			}
			.katex-display-container::-webkit-scrollbar-thumb:hover {
				background: rgba(0,0,0,0.5);
			}
		`;
		if (!document.head.querySelector('style[data-katex-scrollbar]')) {
			style.setAttribute('data-katex-scrollbar', 'true');
			document.head.appendChild(style);
		}

		element.setAttribute('data-scrollbar-initialized', 'true');
	});
}

function initTranslate() {
	if (!siteConfig.translate?.enable || !window.translate || window.translateInitialized) return;

	// 配置translate.js
	if (siteConfig.translate.service) {
		window.translate.service.use(siteConfig.translate.service);
	}

	if (siteConfig.translate.defaultLanguage) {
		window.translate.language.setLocal(siteConfig.translate.defaultLanguage);
	}

	if (siteConfig.translate.autoDiscriminate) {
		window.translate.setAutoDiscriminateLocalLanguage();
	}

	// 设置忽略的类名和标签
	if (siteConfig.translate.ignoreClasses) {
		siteConfig.translate.ignoreClasses.forEach(className => {
			window.translate?.ignore.class.push(className);
		});
	}

	if (siteConfig.translate.ignoreTags) {
		siteConfig.translate.ignoreTags.forEach(tagName => {
			window.translate?.ignore.tag.push(tagName);
		});
	}

	// 不显示默认的select选择框
	if (siteConfig.translate.showSelectTag === false) {
		window.translate.selectLanguageTag.show = false;
	}

	// 禁用自动保存翻译状态到localStorage
	window.translate.storage.set = function() {
		// 空函数，阻止保存状态
	};

	// 启动翻译监听
	window.translate.listener.start();

	// 标记已初始化
	window.translateInitialized = true;

	// 执行翻译初始化
	window.translate?.execute();
}

// 懒加载并初始化翻译功能
async function loadAndInitTranslate() {
	if (!siteConfig.translate?.enable) return;

	try {
		await window.loadTranslateScript?.();
		initTranslate();
	} catch (error) {
		console.error('Failed to load translate.js:', error);
	}
}

// 页面加载完成后自动初始化翻译
if (siteConfig.translate?.enable) {
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', loadAndInitTranslate);
	} else {
		loadAndInitTranslate();
	}
}

// 初始化粒子特效
function setupParticle() {
	const particleConfig = (widgetConfigs as any)?.particle;
	if (!particleConfig || !particleConfig.enable) return;
	if ((window as any).particleInitialized) return;
	initParticle(particleConfig);
	(window as any).particleInitialized = true;
}

// 页面加载完成后自动初始化粒子特效
if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', setupParticle);
} else {
	setupParticle();
}

// 初始化Swup
const setup = () => {
	// TODO: temp solution to change the height of the banner
/*
	window.swup.hooks.on('animation:out:start', () => {
		const path = window.location.pathname
		const body = document.querySelector('body')
		if (path[path.length - 1] === '/' && !body.classList.contains('is-home')) {
			body.classList.add('is-home')
		} else if (path[path.length - 1] !== '/' && body.classList.contains('is-home')) {
			body.classList.remove('is-home')
		}
	})
*/
	window.swup.hooks.on('link:click', () => {
		// Remove the delay for the first time page load
		document.documentElement.style.setProperty('--content-delay', '0ms')

	})
	window.swup.hooks.on('content:replace', () => {
		// Only handle scrollbars for new Katex elements, using native CSS scrollbars.
		initCustomScrollbar();

		// Re-execute the translation after the page content is replaced (only if the translation has already been loaded).
		if (siteConfig.translate?.enable && window.translateInitialized && window.translate) {
			// 使用requestAnimationFrame优化性能，减少延迟
			requestAnimationFrame(() => {
				window.translate?.execute();
			});
		}

		// 重新初始化semifull模式的滚动检测
		const navbar = document.getElementById('navbar')
		if (navbar) {
			const transparentMode = navbar.getAttribute('data-transparent-mode')

			if (transparentMode === 'semifull') {
				// 重新调用初始化函数来重新绑定滚动事件
				if (typeof (window as any).initSemifullScrollDetection === 'function') {
					(window as any).initSemifullScrollDetection()
				}
			}
		}
	})
	window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
		// change banner height immediately when a link is clicked
		const bodyElement = document.querySelector('body')
		const isHomePage = pathsEqual(visit.to.url, url('/'))

		if (isHomePage) {
			bodyElement!.classList.add('lg:is-home');
		} else {
			bodyElement!.classList.remove('lg:is-home');
		}



		// Control navbar transparency based on page
		const navbar = document.getElementById('navbar')
		if (navbar) {
			navbar.setAttribute('data-is-home', isHomePage.toString())

			// 重新初始化semifull模式的滚动检测
			const transparentMode = navbar.getAttribute('data-transparent-mode')
			if (transparentMode === 'semifull') {
				// 重新调用初始化函数来重新绑定滚动事件
				if (typeof window.initSemifullScrollDetection === 'function') {
					window.initSemifullScrollDetection()
				}
			}
		}

		// Control mobile banner visibility based on page with improved staging animation
		const bannerWrapper = document.getElementById('banner-wrapper')
		const mainContentWrapper = document.querySelector('.absolute.w-full.z-30')

		if (bannerWrapper && mainContentWrapper) {
			if (isHomePage) {
				// 首页：延迟移除隐藏类，让banner和内容优雅地出现
				setTimeout(() => {
					bannerWrapper.classList.remove('mobile-hide-banner')
				}, 100)
				setTimeout(() => {
					mainContentWrapper.classList.remove('mobile-main-no-banner')
				}, 150)
			} else {
				// 非首页：分阶段隐藏，先隐藏banner，再移动内容
				bannerWrapper.classList.add('mobile-hide-banner')
				// 延迟移动内容，让banner先完全消失
				setTimeout(() => {
					mainContentWrapper.classList.add('mobile-main-no-banner')
				}, 100)
			}
		}

		// increase the page height during page transition to prevent the scrolling animation from jumping
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}

		// Hide the TOC while scrolling back to top
		let toc = document.getElementById('toc-wrapper');
		if (toc) {
			toc.classList.add('toc-not-ready')
		}
	});
	window.swup.hooks.on('page:view', () => {
		// hide the temp high element when the transition is done
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}

		// 确保页面滚动到顶部，特别是移动端banner关闭时
		window.scrollTo({
			top: 0,
			behavior: 'instant'
		});

		// 检查当前页面是否为文章页面，如果是则触发自定义事件用于初始化评论系统
		setTimeout(() => {
			if (document.getElementById('tcomment')) {
				// 触发自定义事件，通知评论系统页面已完全加载
				const pageLoadedEvent = new CustomEvent('twilight:page:loaded', {
					detail: {
						path: window.location.pathname,
						timestamp: Date.now()
					}
				});
				document.dispatchEvent(pageLoadedEvent);
				console.log('Layout: 触发 twilight:page:loaded 事件，路径:', window.location.pathname);
			}
		}, 300);
	});

if (window?.swup?.hooks) {
	setup()
} else {
	document.addEventListener('swup:enable', setup)
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let toc = document.getElementById('toc-wrapper');
let navbar = document.getElementById('navbar-wrapper')

// 节流函数
function throttle(func: (...args: any[]) => void, limit: number) {
	let inThrottle: boolean;
	return function(this: any, ...args: any[]) {
		if (!inThrottle) {
			func.apply(this, args);
			inThrottle = true;
			setTimeout(() => inThrottle = false, limit);
		}
	}
}

function scrollFunction() {
	const scrollTop = document.documentElement.scrollTop;
}

// 使用节流优化滚动性能
window.onscroll = throttle(scrollFunction, 16); // 约60fps

window.onresize = () => {
	// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
	let offset = Math.floor(window.innerHeight);
	offset = offset - offset % 4;
	document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

</script>